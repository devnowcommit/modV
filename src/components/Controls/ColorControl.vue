<template>
  <div class="color-control">
    <label :for="inputId">
      {{ label }}
    </label>
    <sketch-picker :id="inputId" v-model="pickerValue" ref="colorPicker" />
  </div>
</template>

<script>
  import { Sketch } from 'vue-color';

  export default {
    name: 'colorControl',
    data() {
      return {
        pickerColors: {},
        pickerValue: [0, 0, 0, 0],
      };
    },
    computed: {
      value: {
        get() {
          return this.$store.state.modVModules.active[this.moduleName][this.variable];
        },
        set(value) {
          const data = this[this.options.returnFormat || 'rgbaArray'](value);

          this.$store.dispatch('modVModules/updateProp', {
            name: this.moduleName,
            prop: this.variable,
            data,
          });
        },
      },
      options() {
        return this.meta.control.options;
      },
    },
    mounted() {
      const { value } = this;

      if (Array.isArray(this.value) && this.options.returnFormat === 'mappedRgbaArray') {
        if (this.value.length < 4) {
          this.pickerValue = {
            r: Math.map(value[0], 0, 1.0, 0.0, 255),
            g: Math.map(value[1], 0, 1.0, 0.0, 255),
            b: Math.map(value[2], 0, 1.0, 0.0, 255),
          };
        } else {
          this.pickerValue = {
            r: Math.map(value[0], 0, 1.0, 0.0, 255),
            g: Math.map(value[1], 0, 1.0, 0.0, 255),
            b: Math.map(value[2], 0, 1.0, 0.0, 255),
            a: Math.map(value[3], 0, 1.0, 0.0, 255),
          };
        }
      } else if (Array.isArray(this.value)) {
        if (this.value.length < 4) {
          this.pickerValue = {
            r: value[0],
            g: value[1],
            b: value[2],
          };
        } else {
          this.pickerValue = {
            r: value[0],
            g: value[1],
            b: value[2],
            a: value[3],
          };
        }
      }

      const data = this[this.options.returnFormat || 'rgbaArray'](this.pickerValue);

      this.$store.dispatch('modVModules/updateProp', {
        name: this.moduleName,
        prop: this.variable,
        data,
      });
    },
    methods: {
      rgbArray(value) {
        if (!('rgba' in value)) return [0, 0, 0];

        const rgba = value.rgba;
        return [rgba.r, rgba.g, rgba.b];
      },
      rgbString(value) {
        if (!('rgba' in value)) return [0, 0, 0, 0];

        const rgba = value.rgba;

        return `rgb(${rgba.r}, ${rgba.g}, ${rgba.b})`;
      },
      rgbaString(value) {
        if (!('rgba' in value)) return [0, 0, 0, 0];

        const rgba = value.rgba;

        return `rgba(${rgba.r}, ${rgba.g}, ${rgba.b}, ${rgba.a})`;
      },
      rgbaArray(value) {
        if (!('rgba' in value)) return [0, 0, 0, 0];

        const rgba = value.rgba;
        return [rgba.r, rgba.g, rgba.b, rgba.a];
      },
      mappedRgbaArray(value) {
        if (!('rgba' in value)) return [0, 0, 0, 0];

        const rgba = value.rgba;
        const red = Math.map(rgba.r, 0, 255, 0.0, 1.0);
        const green = Math.map(rgba.g, 0, 255, 0.0, 1.0);
        const blue = Math.map(rgba.b, 0, 255, 0.0, 1.0);
        const alpha = Math.map(rgba.a, 0, 1, 0.0, 1.0);

        return [red, green, blue, alpha];
      },
      hexString(value) {
        return value.hex;
      },
      hsvArray(value) {
        if (!('hsv' in value)) return [0, 0, 0];

        const hsv = value.hsv;
        return [hsv.r, hsv.g, hsv.b];
      },
      // hsvString(value) {

      // },
      hsvaArray(value) {
        if (!('hsv' in value)) return [0, 0, 0, 0];

        const hsva = value.hsv;
        return [hsva.r, hsva.g, hsva.b, hsva.a];
      },
      // hsvaString(value) {

      // },
      hslArray(value) {
        if (!('hsl' in value)) return [0, 0, 0];

        const hsl = value.hsl;
        return [hsl.r, hsl.g, hsl.b];
      },
      // hslString(value) {

      // },
      hslaArray(value) {
        if (!('hsl' in value)) return [0, 0, 0, 0];

        const hsla = value.hsl;
        return [hsla.r, hsla.g, hsla.b, hsla.a];
      },
      // hslaString(value) {

      // },
    },
    components: {
      'sketch-picker': Sketch,
    },
    watch: {
      pickerValue(value) {
        this.value = value;
      },
    },
  };
</script>

<style scoped lang='scss'>
</style>
